<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Login to Azure AD using cypress - Mahesh's Tech Helpers</title>

  <!-- Edit site and author settings in `_config.yml` to make the social details your own -->

    <meta content="Mahesh's Tech Helpers" property="og:site_name">
  
    <meta content="Login to Azure AD using cypress" property="og:title">
  
  
    <meta content="article" property="og:type">
  
  
    <meta content="Login to Azure AD using cypress." property="og:description">
  
  
    <meta content="/cypress-azureAD-login/" property="og:url">
  
  
    <meta content="2019-10-20T14:38:20+01:00" property="article:published_time">
    <meta content="/about/" property="article:author">
  
  
    <meta content="/assets/img/mahesh.jpg" property="og:image">
  
  
    
  
  
    
    <meta content="cypress" property="article:tag">
    
    <meta content="azure" property="article:tag">
    
    <meta content="office365" property="article:tag">
    
    <meta content="puppeteer" property="article:tag">
    
  

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@">
    <meta name="twitter:creator" content="@mtanneeru17">
  
    <meta name="twitter:title" content="Login to Azure AD using cypress">
  
  
    <meta name="twitter:url" content="/cypress-azureAD-login/">
  
  
    <meta name="twitter:description" content="Login to Azure AD using cypress.">
  
  
    <meta name="twitter:image:src" content="/assets/img/mahesh.jpg">
  

	<meta name="description" content="Login to Azure AD using cypress.">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta property="og:image" content="">
	<link rel="shortcut icon" href="/assets/img/favicon/favicon.ico" type="image/x-icon">
	<link rel="apple-touch-icon" href="/assets/img/favicon/favicon1.png ">
	<link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicon/favicon2.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicon/favicon2.png">
	<!-- Chrome, Firefox OS and Opera -->
	<meta name="theme-color" content="#263959">
	<!-- Windows Phone -->
	<meta name="msapplication-navbutton-color" content="#263959">
	<!-- iOS Safari -->
	<meta name="apple-mobile-web-app-status-bar-style" content="#263959">
	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=PT+Serif:400,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="/assets/fonts/font-awesome/css/font-awesome.min.css">
	<!-- Styles -->
  <link rel="stylesheet" href="/assets/css/main.css">
  
   
</head>

<body>

  <div class="wrapper">
    <aside class="sidebar">
  <header>
    <div class="about">
      <div class="cover-author-image">
        <a href="/"><img src="/assets/img/mahesh.jpg" alt="MAHESH TANNEERU"></a>
      </div>
      <div class="author-name">MAHESH TANNEERU</div>
      <p>I am an enthusiastic Software Engineer and a good Human being :)</p>
    </div>
  </header> <!-- End Header -->
  <footer>
    <section class="contact">
      <h3 class="contact-title">Contact me</h3>
      <ul>
        
          <li><a href="https://twitter.com/mtanneeru17" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
        
        
          <li class="github"><a href="http://github.com/tanneerumahesh" target="_blank"><i class="fa fa-github"></i></a></li>
        
        
          <li class="linkedin"><a href="https://in.linkedin.com/in/mahesh-tanneeru/" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        
        
          <li class="email"><a href="mailto:tanneerumahesh@gmail.com"><i class="fa fa-envelope-o"></i></a></li>
        
      </ul>
    </section> <!-- End Section Contact -->
    <div class="copyright">
      <p>2022 &copy; MAHESH TANNEERU</p>
    </div>
  </footer> <!-- End Footer -->
</aside> <!-- End Sidebar -->
<div class="content-box clearfix">
    <script src="/js/lunr.js"></script>

<script>

var documents = [{
    "id": 0,
    "url": "/",
    "title": "",
    "body": "{% for post in paginator. posts %}  {% if post. img %}  &lt;a class= post-thumbnail  style= background-image: url({{ /assets/img/  | prepend: site. baseurl | append : post. img}})  href= {{post. url | prepend: site. baseurl}} &gt;&lt;/a&gt; {% else %} {% endif %}   {{post. title}}:   {{ post. content | strip_html | truncatewords: 15 }}   {{post. date | date: '%Y, %b %d'}}&nbsp;&nbsp;&nbsp;—&nbsp;  {% capture words %}{{ post. content | number_of_words }}{% endcapture %}{% unless words contains  -  %}{{ words | plus: 250 | divided_by: 250 | append:   minute read  }}{% endunless %} {% endfor %} {% include pagination. html %} "
    }, {
    "id": 1,
    "url": "/tags/",
    "title": "Tags",
    "body": "      {% capture site_tags %}{% for tag in site. tags %}{{ tag   first }}{% unless forloop. last %},{% endunless %}{% endfor %}{% endcapture %}           {% assign tag_words = site_tags   split:’,’   sort %}    Tags in Blog  {% for this_word in tag_words %}  {{ this_word }} ({{ site. tags[this_word]. size }}) {% endfor %}  {% for this_word in tag_words %} {{ this_word }}:   {% for post in site. tags[this_word] %}{% if post. title != null %}      {{ post. title }}    | {{ post. date | date_to_string }}    {% endif %}{% endfor %} {% endfor %}"
    }, {
    "id": 2,
    "url": "/robots.txt",
    "title": "",
    "body": "      Sitemap: {{ “sitemap. xml”   absolute_url }}   "
    }, {
    "id": 3,
    "url": "/page/2/",
    "title": "",
    "body": "{% for post in paginator. posts %}  {% if post. img %}  &lt;a class= post-thumbnail  style= background-image: url({{ /assets/img/  | prepend: site. baseurl | append : post. img}})  href= {{post. url | prepend: site. baseurl}} &gt;&lt;/a&gt; {% else %} {% endif %}   {{post. title}}:   {{ post. content | strip_html | truncatewords: 15 }}   {{post. date | date: '%Y, %b %d'}}&nbsp;&nbsp;&nbsp;—&nbsp;  {% capture words %}{{ post. content | number_of_words }}{% endcapture %}{% unless words contains  -  %}{{ words | plus: 250 | divided_by: 250 | append:   minute read  }}{% endunless %} {% endfor %} {% include pagination. html %} "
    }, {
    "id": 4,
    "url": "/my-tech-stack/",
    "title": "MY TECH STACK",
    "body": "2022/04/17 - Why do i need to capture these ?: Ok so this is for future me :) i have been working with multiple tools and technologies as part of contarcting gigs and often forget few after some time!. i will try to capture any new tools/technologies/platforms/frameworks as part of this post and this post will be updated on a regular basis. TOOLS/TECHNOLOGIES/FRAMEWORKS/PLATFORMS: Web Test Automation:       tool   Description   Pros   Cons   Comment         Playwright                       Cypress                       Taiko                       WebdriverIO                       Selenium Webdriver                       Nightwatch                       TestCafe                       Protractor                   Mobile Test Automation:       tool   Description   Pros   Cons   Comment         Appium                       Detox                       XC UI Test                       Espresso                   Record and playback automation tools:       tool   Description   Pros   Cons   Comment         Telerik Test Studio                       TestCafé Studio                       Tosca                       test. ai                       mabl                   API Manual / Automation testing:       tool   Description   Pros   Cons   Comment         Postman                       Ready API                       Insomnia                   Contract testing:       tool   Description   Pros   Cons   Comment         Pact                       Pactflow                   Performance / Load Testing:       tool   Description   Pros   Cons   Comment         k6                       Gatling                       Jmeter                       Locust                   Webpage Performance / Checks:       tool   Description   Pros   Cons   Comment         Lighthouse                       HTML navigation API                   Proxy Tools:       tool   Description   Pros   Cons   Comment         Proxyman                       Charls proxy                   DATA Transformations / QA:       tool   Description   Pros   Cons   Comment         DVT                       Qlik                       DBT                       ADF                   BDD:       tool   Description   Pros   Cons   Comment         Cucumber                       Specflow                       Gauge                   Cross browser / Device testing:       tool   Description   Pros   Cons   Comment         BrowserStack                       Saucelabs                       LambdaTest                       Perfecto                   CI tools:       tool   Description   Pros   Cons   Comment         Gitlab                       Github Actions                       AzureDevops                       CloudBuild                       Jenkins                       TeamCity                   Messaging/EventDriven:       tool   Description   Pros   Cons   Comment         AWS SQS/SNS                       Punsub                       KAFKA                       RabbitMQ                       PUSH                       DIFFUSION                   Workflow tracking:       tool   Description   Pros   Cons   Comment         AWS SWF                   Infrastricture / Devops:       tool   Description   Pros   Cons   Comment         Kubernetes                       GKE                       EKS                       Docker                       Terraform                   BIG DATA:       tool   Description   Pros   Cons   Comment         Hadoop                       Spark                       BigQuery                   Machine Learning / AI:       tool   Description   Pros   Cons   Comment         AWS sage maker                       TensorFlow                       BigQuery ML                   Secrets manager:       tool   Description   Pros   Cons   Comment         AWS Cognito                   "
    }, {
    "id": 5,
    "url": "/setup-cucumberjs-vs-code/",
    "title": "Setup cucumberJS in VS Code (with navigation to steps and step definitions generation)",
    "body": "2021/11/09 - Problem :: While using cucumberJS in VS Code we have to navigate to the step definition file (from steps in features) and generate the step definitions (rather than writing steps defs manually to save time!). while this is all possible it is not very straight forward to setup. Solution ::    Install Cucumber extensions      Install Cucumber (Gherkin) Full Support extension to support cucumber JS actions   Install Cuke Step Definition Generator extension to generate step definitions from feature files.       Add bellow settings to VS Code workspace settings. json file (note: it seems there is a bug with extension where settings in user's settings are not loaded correctly. so we need to add bellow settings to VS Code workspace settings. json file)   {   cucumberautocomplete. steps : [     steps/*. ts ,     hooks/*. ts   ],   cucumberautocomplete. syncfeatures :  features/*feature ,   cucumberautocomplete. strictGherkinCompletion : false,   cucumberautocomplete. smartSnippets : true,   cucumberautocomplete. stepsInvariants : true}       update paths in cucumberautocomplete. steps with relative paths to your steps/hooks folders   update paths in  cucumberautocomplete. syncfeatures  with relative paths to your features folders      restart VS Code      To navigate to step definitions from feature files use CTRL(or CMD) + click on step in feature file.    To generate step definitions from feature files, select step and click on Generate step definitions link on top right   "
    }, {
    "id": 6,
    "url": "/multiple-github-accounts-on-same-machine/",
    "title": "How to add multiple github accounts (like personal and work or [multiple work accounts]) on same machine",
    "body": "2021/11/07 - Problem :: There might be cases where we need to work with multiple github repos from different github accounts on same machine (like personal and work [or multiple work accounts]). we should be able to do this easily by configuring ssh configs. Solution ::    Create new ssh keys for the accounts you want to work with      navigate to . ssh folder   run ssh-keygen -t ed25519 -C  test-user@test-site. com  to generate public and private keys [this needs to be done for all accounts]   add a filename related to account which can be easily identified      Update ssh config with details created in above step      open config file in . ssh folder       add the following sections for each account (if we have three accounts we need to add three host sections with different host names)     Host hostName {any name related to account}    HostName github. com    User git  IdentityFile ~/. ssh/{private file name created in above step [file without . pub extension]}  AddKeysToAgent yes  PreferredAuthentications publickey  UseKeychain yes  IdentitiesOnly yes             Add key to ssh agent (so that we don’t need to enter password with git actions)      ssh-add -K {private file name created in step 1 [file without . pub extension]}      Add public key to github account      navigate to . ssh folder   open public key file [file with . pub extension] related to account   copy the content of the file to clipboard   navigate to github account   click on settings   click on SSH and GPG keys   click on add key   paste the content of the file to clipboard   click on add key   click on save      Add github account to individual git repos      open git config in repo (config file in . git folder)       add/update following section with host name related to account added in step 2     [remote  origin ]  url = git@{hostNameRelatedToAccount}:{githubAccount}/{repoName}. git  fetch = +refs/heads/*:refs/remotes/origin/*              add/update following section with username and email related to account      ``` [user]   name = {username related to account}   email = {user email related to account} ```          All done! we should be able to use logins from different github accounts on same machine. "
    }, {
    "id": 7,
    "url": "/scheduling-automation-test-build-in-jenkins-scripted-pipelines/",
    "title": "Scheduling automation test builds in jenkins",
    "body": "2020/12/01 - What :: We need to schedule builds in CI pipelines when we want to run automation tests on a schedule basis, this is straight forward if we want to do it through UI for ci tools but when it comes to Jenkins scripted pipelines we need to add some code (couple of lines!) to do it. How ::    Define schedules: we can define schedules using pipelineTriggers property with corn format   Example: // this will trigger builds at 7 AM, 12 PM, 4 PM (we can add as many as we can!) def scheduledTriggers = [pipelineTriggers([cron('0 7 * * * \n 0 12 * * * \n 0 16 * * *')])]          Add pipeline triggers to properties: we need to pass schedules defined above tp properties so that schedules will be picked up by jenkins   Example: // this will trigger builds at 7 AM, 12 PM, 4 PM (we can add as many as we can!) def scheduledTriggers = [pipelineTriggers([cron('0 7 * * * \n 0 12 * * * \n 0 16 * * *')])]     properties([scheduledTriggers])   FAQs:    How can i add a trigger in declarative pipelines ?      using triggers property     Example:  triggers {   cron('0 7 * * * \n 0 12 * * * \n 0 16 * * *') }      I don’t know much about corn Jobs ?      we can use https://crontab. guru/ to understand corn schedules and create schedules   "
    }, {
    "id": 8,
    "url": "/api-automation-postman/",
    "title": "Api automation testing using postman",
    "body": "2020/03/05 - WHY?: Because its easy to automate api testing using postman :) NOTE: I would choose postman for automation if my APIs are simple and validations doesn’t involve any complex validations or connecting to other systems. HOW?: Lets make it simple (really simple!), we are going to use https://jsonplaceholder. typicode. com/todos/1 as our test api which returns below response and we are going to automate testing this response {  userId : 1,  id : 1,  title :  delectus aut autem ,  completed : false}Test Api manually:    Open postman (install postman if not already installed)     Go to Collections tab and create a new collection       Click on Add requests, add Request name and save it       Go to created request tab and add a get request to https://jsonplaceholder. typicode. com/todos/1. click on send and we should see the response as below    Now we manually tested api and all looks good with status code and response, lets see if we can add some assertions programmatically because we don’t want to check all attributes manually all the time! Add programmatic assertions:    Adding Assertions programmatically          Navigate to Tests section, this is where we can add assertions to our request response           There will be few useful snippets in SNIPPETS section, clicking on a snippet will create sample code           Lets say I want an assertion for status code then I can click on Status code snippet which will generate sample code for this assertion and we can modify this code as needed            Lets not be lazy and add another assertion to check the schema and values in response :)      To do this we need to get response into a json object and we can use Response body : JSON value check snippet to generate a sample code for me.          From generated code my response object is in jsonData and I should be able to add assertions on fields in response as below          Save the request      Now whenever we send request all tests will be executed after response received, navigate to test results tab to see test results       Ok all good so far but what happens when a test fail? lets change the userId value to 2 in assertion pm. expect(jsonData. userId). to. eql(2); and send request. expected is 2 and actual is 1 in this case so test should be failed and we should see failed test in results    All good and all Done ? Not yet! We can create tests for our requests and run them from postman now, BUT we don’t want to do this manually! Here comes our friend newman to help us. newman is a command-line collection runner for postman and we can use newman to run our postman collections from command line. Automate test runs:    Install newman using npm install -g newman     Export collection (collection will be exported as json file)       From command-line / terminal navigate to folder where the collection is exported and run newman run {exported collection}. json    That’s it! You should be able to run this when ever there are changes on api or configure it as part of CI. Oh the final bit! What if your boss asks you to send the report of your test results? Instead of sending results from command-line it will be useful if we can send some kind of html report, We have another friend to help us here newman-reporter-htmlextra Generate HTML report:    Install newman-reporter-htmlextra using npm install -g newman-reporter-htmlextra     From command-line / terminal navigate to folder where the collection is exported and run newman run {exported collection}. json -r htmlextra to generate html report (you can use --reporter-htmlextra-export attribute if you want to export it to a specific path, by default report will be created in same folder)       You can see beautiful html report generated like below    "
    }, {
    "id": 9,
    "url": "/cypress-install-proxy-issue/",
    "title": "Handling proxy issue while installing cypress through NPM",
    "body": "2020/01/03 - Problem :: If you are under a corporate proxy some times that proxy might not allow you to download cypress through npm install and cypress can fail with below error. The Cypress App could not be downloaded. Does your workplace require a proxy to be used to access the Internet? If so, you must configure the HTTP_PROXY environment variable before downloading Cypress. Read more: https://on. cypress. io/proxy-configuration Otherwise, please check network connectivity and try againSolution ::    As a permanent solution talk to your infrastructure /security teams! And ask them to add cypress domain to proxy white list.     As a temporary solution      Download the zipfile manually by accessing link [https://download. cypress. io/desktop/3. 4. 1?platform=win32&amp;arch=x64] from browser   Set downloaded file as environment variable for CYPRESS_INSTALL_BINARY using export CYPRESS_INSTALL_BINARY=/C/Users/username/downloads/cypress. zip   Run npm i now and cypress should be installed successfully.    "
    }, {
    "id": 10,
    "url": "/teamcity-do-not-run-build-while-another-build-in-progress/",
    "title": "TeamCity - Do not run a build while another build is in progress",
    "body": "2019/10/29 - Problem :: I came across this issue in TeamCity today where as part of CI my automation tests are running against dev environment and sometimes tests are failing because deployment build triggered while test build is in progress. in this case my tests will fail because site will be down for few mins as part of deployment. So I need a way to tell TeamCity that do not run deployment build while automation test build is in progress. Solution :: To solve this problem I need to configure builds in a way that one build should not run while other build is in progress. Apparently it’s not that straight forward in TC [at least for me!], I tried different ways but what worked for me is locking builds using shared resources. Below are the steps to configure this. 1. Create a shared resource at project level : Project -&gt; Shared Resources -&gt; Add a shared resource 2. Add a Resource name and select Resource with quota from resource type 3. Enter 1 in resource quota field 4. Save resource 5. Navigate to Deployment build configuration 6. Go to Build Features -&gt; Add build feature -&gt; Shared resources -&gt; Add Lock 7. Select resource name created above and select Write Lock in lock type 8. Save Lock 9. Repeat steps 5-8 for automation tests build DONE : only one of these builds will run at a time now. "
    }, {
    "id": 11,
    "url": "/aws-cli-mfa/",
    "title": "Using MFA with aws cli to switch roles",
    "body": "2019/10/28 - Problem :: If we have MFA(multi factor authentication) setup enabled on AWS console then we need to generate temporary access/secret keys and session token with MFA to access aws services through aws cli. lets see how we can do it!. Solution ::  Get MFA device arn from AWS console     Click on account name -&gt; click on My security credentials       Get device ARN from ‘Assigned MFA Device’ section in ‘Multi-factor authentication (MFA)’ section    Run below command to get temp credentials [by replacing arn and token code]  aws sts assume-role --role-arn {Role ARN} --role-session-name {Session name} --serial-number {MFA device ARN from above step} --token-code {token code}     Note: duration can be set between 900 and 129600 using –duration-seconds 129600 [this might vary based on role configuration. ]   Above command should output access/secret/session tokens which should look like below  {  Credentials : {    AccessKeyId :  ASIA56SNEE5Y3SEU4K6S ,    SecretAccessKey :  0R/eUqKTavYUKm6dMXiASQP5hwygaxJCi/FrfvXe ,    SessionToken :  FQoGZXIvYXdzEHcaDAwcmHZVDwstu1jUnCL1AYJJF8WY98Xw4vQ/bWvU5bfHqjtgp0ras2JSD9TBKdtdLjnMcSDweK4pwkMPVmKjSLBVqfh0t/p5WKJsKTvmhiEoUBiy7gzaBGfOC8Ue+XG+6SYt1N7etbYJ/5+F4xPFfns36dCAy1KULTD+7FH9/Wt4tHK5xetFSmD+jgf2z5H3uHhkR4khd7OAdN1mp+YOLoHZfYpV3FgdmOozFtXKi2YWg7IK+2BQj2N2A/2kaCizE29UMWAEVZhO/8tE4kf/q/XrvWt1+SAb/7nZRUhw1Qu5vfpvEzvkMOfYSE0YNZbs/5Cy4MXZ5A9g00OpHcytAOZ8Sga1KL65nO0F ,    Expiration :  2019-10-16T14:35:58Z  },  AssumedRoleUser : {    AssumedRoleId :  FRESCVHHNBGFFF45FRS:testRole ,    Arn :  arn:aws:sts::65764765765:assumed-role/AccessToTestDev/testRole  } }       Use access and secret keys from above step to connect to AWS resources     Note: keep in mind that there is an expiration for session token so when token expired we need to refresh the token again   "
    }, {
    "id": 12,
    "url": "/cypress-azureAD-login/",
    "title": "Login to Azure AD using cypress",
    "body": "2019/10/20 - Problem :: I have a requirement to automate azure ad login using cypress. Requirement is when user navigated to site-P it will redirect to azure AD login page where user has to enter login details and they will get redirected to site-P once login is successful. By design cypress doesn’t allow this because of many reasons as described here. I am not going to discuss good and bad about this here [as it’s a vast topic on its own!] but can show you how I managed to workaround this problem. Solution :: Approach: After completing login process user will be redirected to my site and there will be couple of cookies added to site at this point [this might be different for different sites!], which will be used for any further authentication on site. So if I can get those cookies and add it to browser before starting cypress tests all should work [in theory] How to do it ?: Use puppeteer to complete the Azure login and extract cookies. [i am using puppeteer because it looks simple to me but any ui automation tool should do it] 1. Install puppeteer using npm install puppeteer. 2. Create a GetCookies. js file in support folder. 3. Add below code to GetCookies. js which will login to Azure and extract cookies to cookies. json file. const puppeteer = require( puppeteer ); const test_file = require( fs ); puppeteer . launch({headless: true, chromeWebSecurity: false, args: ['--no-sandbox'] }). then(async browser =&gt; {   const page = await browser. newPage();   await page. goto( {site-url );   await page. waitFor(2000);   await page. waitForSelector('input[name=loginfmt]');   await page. type( input[name=loginfmt] ,  test123 , {applyDelay: 50 });   await page. waitForSelector( input[type=submit] );   await page. click( input[type=submit] );   await page. waitFor(2000);   await page. waitForSelector( input[name=passwd] );   await page. click( input[name=passwd] );   await page. type( input[name=passwd] ,  test123 , {applyDelay: 50});   await page. waitForSelector( input[type=submit] );   await page. click( input[type=submit] );   await page. waitFor(2000);   await page. click( input[type=submit] );   await page. waitFor(2000);   await page. waitForSelector( h3 )   const cookiesFromPage = await page. cookies();    let cookies = [];    for (let cookie of cookiesFromPage) {     let coo = {};     coo. name = cookie. name;     coo. value = cookie. value;     coo. domain = cookie. domain;     coo. path = cookie. path;     coo. expires = cookie. expires;     coo. size = cookie. size;     coo. httpOnly = cookie. httpOnly;     cookies. push(coo);    }   test_file. writeFileSync(  cookies. json , JSON. stringify(cookies));   browser. close();  }); function applyDelay(time) { return new Promise(function (resolve) {setTimeout(resolve, time);}); } 4. We need to add cookies to browser before starting cypress tests, add below function to support/commands. js which will add cookies to browser. Cypress. Commands. add( loadCookies , () =&gt; {  cy. clearLocalStorage(); return cy. fixture( cookies. json ). then(data =&gt; {   for (let cookie of data) {    cy. setCookie(cookie. name, cookie. value, {    domain: cookie. domain,     path: cookie. path,     expiry: cookie. expires,     httpOnly: cookie. httpOnly    });   }  }); }); 5. Call load cookies command in beforeEach so that cookies will be loaded before test. describe('Azure login', () =&gt; {  beforeEach(() =&gt; {   cy. loadCookies();   cy. visit('/');  });  it('Test Home page', () =&gt; {    // this should work!   }); 6. Finally we have to make sure that puppeteer script runs before starting cypress tests. Add below scripts to package. json to run puppeteer and cypress in sequential order  scripts : {  get-cookies :  node cypress/support/getCookies. js &amp;&amp; mv cookies. json cypress/fixtures , runTests :  npm run get-cookies &amp;&amp; cypress run }7. Now run npm run runTests [if you are lucky everything will work :)] "
    }, {
    "id": 13,
    "url": "/aws-cli-switch-role/",
    "title": "Switch to different role using aws-cli",
    "body": "2019/10/11 - If you ended up on this post you might be struggling to change the IAM role using aws-cli(for any reason) and found this post! i might be able to help here as i had same frustration some time back :) Problem :: From aws console i can login to my account and i can switch role to dev to access aws resources related to dev environment, all looks good here. Now i want to access dev resources from my local as i need to run my tests against dev resources, as usual i ran the tests with my default credentials (configured using aws-cli) and they fail straight away with error no access to resource, this is because my default role will not have access to dev resources. ok i now know the problem and the solution is simple change roles, BUT its not that simple as i tried 10 different ways to change role to dev. Below is the solution worked for me. Solution ::    Open credentials file ~/. aws/credentials     It should already have default profile section with access/secret keys [if not use aws configure to configure secrets]     Add AssumeRole section and a dev profile section in credentials file   [default] aws_access_key_id = abc123 aws_secret_access_key = abc123 [dev]       // new profile but credentials are same as default  aws_access_key_id = abc123 aws_secret_access_key = abc123 [AssumeRole]          // new section role_arn = arn:aws:iam::1235634:role/dev-arm  source_profile = dev      Open config file ~/. aws/config     Add dev profile to config file   [default] region = eu-west-1   [profile dev] // this is new profile region = eu-west-1       Run a sample command like aws iam list-users --profile dev. if your configuration is correct and you are lucky you will see users listed and you can connect to resources in dev role.   Remember you have to run all commands with --profile dev to tell aws-cli to use the role. if you don’t want to use it always [WHICH I DON’T PREFER as you might mess with dev resources like i do!] you can run export AWS_DEFAULT_PROFILE=dev. now you can run commands like aws iam list-users with out --profile dev"
    }];

var idx = lunr(function () {
    this.ref('id')
    this.field('title')
    this.field('body')

    documents.forEach(function (doc) {
        this.add(doc)
    }, this)
});
function lunr_search(term) {
    document.getElementById('lunrsearchresults').innerHTML = '<ul></ul>';
    if(term) {
        document.getElementById('lunrsearchresults').innerHTML = "<p>Search results for '" + term + "'</p>" + document.getElementById('lunrsearchresults').innerHTML;
        //put results on the screen.
        var results = idx.search(term);
        if(results.length>0){
            //console.log(idx.search(term));
            //if results
            for (var i = 0; i < results.length; i++) {
                // more statements
                var ref = results[i]['ref'];
                var url = documents[ref]['url'];
                var title = documents[ref]['title'];
                var body = documents[ref]['body'].substring(0,160)+'...';
                document.querySelectorAll('#lunrsearchresults ul')[0].innerHTML = document.querySelectorAll('#lunrsearchresults ul')[0].innerHTML + "<li class='lunrsearchresult'><a href='" + url + "'><span class='title'>" + title + "</span><br /><span class='body'>"+ body +"</span><br /><span class='url'>"+ url +"</span></a></li>";
            }
        } else {
            document.querySelectorAll('#lunrsearchresults ul')[0].innerHTML = "<li class='lunrsearchresult'>No results found...</li>";
        }
    }
    return false;
}
</script>
<style>
    #lunrsearchresults {padding-top: 0.2rem;}
    .lunrsearchresult {padding-bottom: 1rem;}
    .lunrsearchresult .title {color: #d9230f;}
    .lunrsearchresult .url {color: silver;}
    .lunrsearchresult a {display: block; color: #777;}
    .lunrsearchresult a:hover, .lunrsearchresult a:focus {text-decoration: none;}
    .lunrsearchresult a:hover .title {text-decoration: underline;}
</style>


<form onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
    <p><input type="text" class="form-control" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Search Articles" style="border-color: #53a7e8;" /></p>
</form>
<div id="lunrsearchresults">
    <ul></ul>
</div>
  <article class="article-page">
  <div class="page-content">
    
    
    <div class="wrap-content">
      <header class="header-page">
        <h1 class="page-title">Login to Azure AD using cypress</h1>
        <div class="page-date"><span>2019, Oct 20&nbsp;&nbsp;&nbsp;&nbsp;</span></div>
      </header>
      <h3 id="problem-">Problem :</h3>
<p>I have a requirement to automate  azure ad login using cypress. Requirement is when user navigated to site-P it will redirect to azure AD login page where user has to enter login details and they will get redirected to site-P once login is successful. By design cypress doesn’t allow this because of many reasons as described <a href="https://docs.cypress.io/guides/references/best-practices.html#Visiting-external-sites">here</a>. I am not going to discuss good and bad about this here [as it’s a vast topic on its own!] but can show you how I managed to workaround this problem.</p>

<h3 id="solution-">Solution :</h3>

<h4 id="approach">Approach</h4>
<p>After completing login process user will be redirected to my site and there will be couple of cookies added to site at this point [this might be different for different sites!], which will be used for any further authentication on site. So if I can get those cookies and add it to browser before starting cypress tests all should work [in theory]</p>

<h4 id="how-to-do-it-">How to do it ?</h4>

<p>Use <code class="language-plaintext highlighter-rouge">puppeteer</code> to complete the Azure login and extract cookies. [i am using puppeteer because it looks simple to me but any ui automation tool should do it]</p>

<p>1.Install puppeteer using <code class="language-plaintext highlighter-rouge">npm install puppeteer</code>.</p>

<p>2.Create a <code class="language-plaintext highlighter-rouge">GetCookies.js</code> file in support folder.</p>

<p>3.Add below code to <code class="language-plaintext highlighter-rouge">GetCookies.js</code> which will login to Azure and extract cookies to <code class="language-plaintext highlighter-rouge">cookies.json</code> file.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">puppeteer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">puppeteer</span><span class="dl">"</span><span class="p">);</span> 
<span class="kd">const</span> <span class="nx">test_file</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">fs</span><span class="dl">"</span><span class="p">);</span> 
<span class="nx">puppeteer</span> <span class="p">.</span><span class="nx">launch</span><span class="p">({</span><span class="na">headless</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">chromeWebSecurity</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="na">args</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">--no-sandbox</span><span class="dl">'</span><span class="p">]</span> <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="k">async</span> <span class="nx">browser</span> <span class="o">=&gt;</span> <span class="p">{</span> 
    <span class="kd">const</span> <span class="nx">page</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">newPage</span><span class="p">();</span> 
    <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">goto</span><span class="p">(</span><span class="dl">"</span><span class="s2">{site-url</span><span class="dl">"</span><span class="p">);</span> 
    <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">waitFor</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span> 
    <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">waitForSelector</span><span class="p">(</span><span class="dl">'</span><span class="s1">input[name=loginfmt]</span><span class="dl">'</span><span class="p">);</span> 
    <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">type</span><span class="p">(</span><span class="dl">"</span><span class="s2">input[name=loginfmt]</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">test123</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span><span class="na">applyDelay</span><span class="p">:</span> <span class="mi">50</span> <span class="p">});</span> 
    <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">waitForSelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">input[type=submit]</span><span class="dl">"</span><span class="p">);</span> 
    <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="dl">"</span><span class="s2">input[type=submit]</span><span class="dl">"</span><span class="p">);</span> 
    <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">waitFor</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span> 
    <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">waitForSelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">input[name=passwd]</span><span class="dl">"</span><span class="p">);</span> 
    <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="dl">"</span><span class="s2">input[name=passwd]</span><span class="dl">"</span><span class="p">);</span> 
    <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">type</span><span class="p">(</span><span class="dl">"</span><span class="s2">input[name=passwd]</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">test123</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span><span class="na">applyDelay</span><span class="p">:</span> <span class="mi">50</span><span class="p">});</span> 
    <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">waitForSelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">input[type=submit]</span><span class="dl">"</span><span class="p">);</span> 
    <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="dl">"</span><span class="s2">input[type=submit]</span><span class="dl">"</span><span class="p">);</span> 
    <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">waitFor</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span> 
    <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="dl">"</span><span class="s2">input[type=submit]</span><span class="dl">"</span><span class="p">);</span> 
    <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">waitFor</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span> 
    <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">waitForSelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">h3</span><span class="dl">"</span><span class="p">)</span> 
    <span class="kd">const</span> <span class="nx">cookiesFromPage</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">cookies</span><span class="p">();</span> 
      <span class="kd">let</span> <span class="nx">cookies</span> <span class="o">=</span> <span class="p">[];</span> 
      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">cookie</span> <span class="k">of</span> <span class="nx">cookiesFromPage</span><span class="p">)</span> <span class="p">{</span> 
        <span class="kd">let</span> <span class="nx">coo</span> <span class="o">=</span> <span class="p">{};</span> 
        <span class="nx">coo</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span> 
        <span class="nx">coo</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span> 
        <span class="nx">coo</span><span class="p">.</span><span class="nx">domain</span> <span class="o">=</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">domain</span><span class="p">;</span> 
        <span class="nx">coo</span><span class="p">.</span><span class="nx">path</span>  <span class="o">=</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">path</span><span class="p">;</span> 
        <span class="nx">coo</span><span class="p">.</span><span class="nx">expires</span> <span class="o">=</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">expires</span><span class="p">;</span> 
        <span class="nx">coo</span><span class="p">.</span><span class="nx">size</span> <span class="o">=</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">size</span><span class="p">;</span> 
        <span class="nx">coo</span><span class="p">.</span><span class="nx">httpOnly</span> <span class="o">=</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">httpOnly</span><span class="p">;</span> 
        <span class="nx">cookies</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">coo</span><span class="p">);</span> 
      <span class="p">}</span> 
    <span class="nx">test_file</span><span class="p">.</span><span class="nx">writeFileSync</span><span class="p">(</span> <span class="dl">"</span><span class="s2">cookies.json</span><span class="dl">"</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">cookies</span><span class="p">));</span> 
    <span class="nx">browser</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span> 
  <span class="p">});</span> 

<span class="kd">function</span> <span class="nx">applyDelay</span><span class="p">(</span><span class="nx">time</span><span class="p">)</span> <span class="p">{</span> 
<span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">{</span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">time</span><span class="p">);});</span> 
<span class="p">}</span> 
</code></pre></div></div>

<p>4.We need to add cookies to browser before starting cypress tests, add below function to <code class="language-plaintext highlighter-rouge">support/commands.js</code> which will add cookies to browser.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Cypress</span><span class="p">.</span><span class="nx">Commands</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="dl">"</span><span class="s2">loadCookies</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span> 
  <span class="nx">cy</span><span class="p">.</span><span class="nx">clearLocalStorage</span><span class="p">();</span>
  <span class="k">return</span> <span class="nx">cy</span><span class="p">.</span><span class="nx">fixture</span><span class="p">(</span><span class="dl">"</span><span class="s2">cookies.json</span><span class="dl">"</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span> 
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">cookie</span> <span class="k">of</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span> 
      <span class="nx">cy</span><span class="p">.</span><span class="nx">setCookie</span><span class="p">(</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">domain</span><span class="p">:</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">domain</span><span class="p">,</span> 
        <span class="na">path</span><span class="p">:</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> 
        <span class="na">expiry</span><span class="p">:</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">expires</span><span class="p">,</span> 
        <span class="na">httpOnly</span><span class="p">:</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">httpOnly</span> 
      <span class="p">});</span> 
    <span class="p">}</span> 
  <span class="p">});</span> 
<span class="p">});</span> 
</code></pre></div></div>

<p>5.Call load cookies command in <code class="language-plaintext highlighter-rouge">beforeEach</code> so that cookies will be loaded before test.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">Azure login</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span> 
  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span> 
    <span class="nx">cy</span><span class="p">.</span><span class="nx">loadCookies</span><span class="p">();</span> 
    <span class="nx">cy</span><span class="p">.</span><span class="nx">visit</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">);</span> 
  <span class="p">});</span> 

  <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">Test Home page</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span> 
      <span class="c1">// this should work! </span>
    <span class="p">});</span> 
</code></pre></div></div>

<p>6.Finally we have to make sure that puppeteer script runs before starting cypress tests. Add below scripts to <code class="language-plaintext highlighter-rouge">package.json</code> to run puppeteer and cypress in sequential order</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="dl">"</span><span class="s2">scripts</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span> 
<span class="dl">"</span><span class="s2">get-cookies</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">node cypress/support/getCookies.js &amp;&amp; mv cookies.json cypress/fixtures</span><span class="dl">"</span><span class="p">,</span>
<span class="dl">"</span><span class="s2">runTests</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">npm run get-cookies &amp;&amp; cypress run</span><span class="dl">"</span>
<span class="p">}</span>
</code></pre></div></div>

<p>7.Now run <code class="language-plaintext highlighter-rouge">npm run runTests</code> [if you are lucky everything will work :)]</p>

      <div class="page-footer">
        <div class="page-share">
          <a href="https://twitter.com/intent/tweet?text=Login to Azure AD using cypress&url=/cypress-azureAD-login/" title="Share on Twitter" rel="nofollow" target="_blank">Twitter</a>
       </div>
        <div class="page-tag">
          
            <a href="/tags#cypress" class="tag">&#35; cypress</a>
          
            <a href="/tags#azure" class="tag">&#35; azure</a>
          
            <a href="/tags#office365" class="tag">&#35; office365</a>
          
            <a href="/tags#puppeteer" class="tag">&#35; puppeteer</a>
          
        </div>
      </div>
      <section class="comment-area">
  <div class="comment-wrapper">
    
  </div>
</section> <!-- End Comment Area -->

    </div> <!-- End Wrap Content -->
  </div> <!-- End Page Content -->
</article> <!-- End Article Page -->

</div>

  </div>
  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', '', 'auto');
  ga('send', 'pageview');
</script> <!-- End Analytics -->

</body>
</html>
